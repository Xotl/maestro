/**
*# (c) Copyright 2014 Hewlett-Packard Development Company, L.P.
*#
*#   Licensed under the Apache License, Version 2.0 (the "License");
*#   you may not use this file except in compliance with the License.
*#   You may obtain a copy of the License at
*#
*#       http://www.apache.org/licenses/LICENSE-2.0
*#
*#   Unless required by applicable law or agreed to in writing, software
*#   distributed under the License is distributed on an "AS IS" BASIS,
*#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
*#   See the License for the specific language governing permissions and
*#   limitations under the License.
*/
'use strict';

var url = require('url');
var http = require('http');
module.exports = {
  gravatar_exist: function(email_hash, exist){
    var req_options = {};

    if(process.env.http_proxy === undefined){
      req_options = {
          host: 'www.gravatar.com',
          port: 80,
          path: '/avatar/' + email_hash + '.png?d=404',
          method: 'HEAD',
      };
    }else{
      var url_req = 'www.gravatar.com/avatar/' + email_hash + '.png?d=404';
      var proxy_url = url.parse(process.env.http_proxy);
      req_options = {
          host: proxy_url.hostname,
          port: proxy_url.port,
          path: url_req,
          method: 'HEAD',
      };
    }

    var head_req = http.request(req_options, function(res) {
        if(res.statusCode == 404){
          exist(false);
        }else if(res.statusCode == 200){
          exist(true);
        }else{
          exist(false);
        }
    });

    head_req.on('socket', function (socket) {
      socket.setTimeout(3000);
      socket.on('timeout', function() {
          head_req.abort();
      });
    });

    head_req.on('error', function (e) {
      console.error('Unable to verify if the gravatar account exist: '+e.message)
      exist(false);
    });

    head_req.end();
  }
}
